<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MCSM - Minecraft Server Management Software</title>

        <%- include("partials/libs.ejs") %>
    </head>
    <body path="/scheduler" class="d-flex flex-column vh-100">
        <%- include("partials/navigation.ejs"); %>
        <main class="vw-100 vh-100 gap-3 p-2">
            <h3><i class="bi bi-stopwatch"></i>Scheduler</h3>
            <hr class="m-1 mb-3">
            <div class="d-flex flex-row-reverse justify-content-center gap-3">
                <div class="d-flex flex-column" style="height: 80vh; width: 50%;">
                    <div class="d-flex gap-2">
                        <button id="do_backup" class="btn btn-success">Do Backup</button>
                        <button id="restart_server" class="btn btn-warning">Restart Server</button>
                    </div>
                    <hr class="mt-2">
                    <div class="p-2" style="overflow: auto;">
                        <h3>Scheduler</h3>
                        <div class="d-flex flex-column gap-2 w-100 p-2" style="background-color: #151515; border-radius: 10px;">
                            <div class="form-check form-switch">
                                <input id="scheduler_enabled" class="form-check-input" <%- isRunning ? "checked" : "" %> type="checkbox">
                                <label class="form-check-label">Enable scheduler</label>
                            </div>
                        </div>
                        <h3 class="mt-2">Backups</h3>
                        <div class="d-flex flex-column gap-2 w-100">
                            <div class=" d-flex flex-column gap-2 p-2 w-100" style="background-color: #151515; border-radius: 10px;">
                                <label for="backups_number">Max backups stored:</label>
                                <input id="scheduler_backups_stored" class="form-control w-25" type="number" min="2" max="100" value="<%- scheduler.backups_stored %>" id="backups_number">
                                <label>Directories to include in backup:</label>
                                <div style="overflow: auto; max-height: 300px;">
                                <% for(let el of scannedDirs) { %>
                                    <div class="form-check">
                                        <input key="<%-el%>" class="scheduler_backup_dir form-check-input" <%- scheduler.backup.indexOf(el) > -1 ? "checked" : "" %> type="checkbox">
                                        <label class="form-check-label"><%-el %></label>
                                    </div>
                                <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .schedule {
                        padding: 10px !important;   
                        justify-content: space-between;
                    }

                    .schedule > div > i {
                        font-size: 30px;
                    }

                    .schedule h4,p {
                        margin: 0;
                    }
                </style>
                <div class="d-flex flex-column" style="height: 80vh; width: 50%;">
                    <h4 class="mt-2">Scheduled Actions:</h4>
                    <div class=" d-flex flex-column-reverse gap-2 p-2 w-100 h-100 justify-content-end" style="background-color: #151515; border-radius: 10px; overflow: auto;">
                        <% 
                            let icons = {
                                "backup": "bi-download",
                                "message": "bi-chat-left-dots-fill",
                                "command": "bi-terminal",
                                "restart": "bi-arrow-clockwise"
                            }
                        %>
                        <% for(let el of scheduler.schedules) { %>
                        <div class="schedule card flex-row align-items-center" style="height: 50px">
                            <div class="d-flex w-75 gap-2 align-items-center">
                                <i class="bi <%-icons[el.type] %>"></i>
                                <h4><%- el.type[0].toUpperCase() + el.type.substring(1, el.type.length) %></h4>
                                <p class="text-muted"><%-(el.command && el.type == "command") ? el.command : el.message %></p>
                            </div>
                            <div class="w-25 d-flex gap-2 align-items-center justify-content-end">
                                <p class="text-muted">(Whole week)</p>
                                <h4><%- el.time %></h4>
                                <button class="btn p-0 m-0 fs-5"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                        <% } %>
                        <button class="schedule btn d-flex flex-row btn-primary align-items-center" style="height: 50px;">
                            <div class="d-flex w-75 gap-2 align-items-center">
                                <i class="bi bi-plus-square"></i>
                                <h4>Add action</h4>
                                <p class="text-muted">Click here to add new scheduled action...</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <%- include("partials/footer.ejs") %>
    </body>

    <script>
        function updateSettings() {
            let enabled = $("#scheduler_enabled").is(":checked");
            let backupsStored = Number($("#scheduler_backups_stored").val());
            let dirs = [];

            $(".scheduler_backup_dir").each((i, el) => {
                let obj = $(el);
                
                if(obj.is(":checked"))
                   dirs.push(obj.attr("key"));
            })

            let data = {
                enabled,
                backupsStored,
                dirs
            }

            socket.emit("scheduler_settings", data)
        }

        $("#do_backup").click(() => {
            socket.emit("do_backup")
        });

        $("#restart_server").click(() => {
            socket.emit("restart_server")
        });

        $(".scheduler_backup_dir").click(() => {
            updateSettings();
        })

        $("#scheduler_enabled").click(() => {
            updateSettings();
        })

        $("#scheduler_backups_stored").change(() => {
            updateSettings();
        })
    </script>
</html>